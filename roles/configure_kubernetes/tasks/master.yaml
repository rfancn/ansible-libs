# For main master node
- name: init main master node
  command: kubeadm init --pod-network-cidr=10.244.0.0/16
  register: result_master_init

- block:
  - name: find node join command 
    command: grep -o 'kubeadm join --token .*' "{{ result_master_init.stdout }}"
    register: result_find_node_join_command

  - name: Set kube_command_node_join variable for future reference
    set_fact: kube_command_node_join={{ result_find_node_join_command.stdout }} 

- block:
  - name: find master member join command
    command: grep -o "kubeadm join --master --token .*" {{ result_master_init.stdout }}
    register: result_find_master_member_join_command
  - name: Set kube_command_mm_join variable for future reference
    set_fact: kube_command_mm_join={{ result_find_master_member_join_command.stdout }} 
  #currently don't support master HA
  ignore_errors: true

- name: setup master environment
  shell:  mkdir -p $HOME/.kube && sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config && sudo chown $(id -u):$(id -g) $HOME/.kube/config

- name: apply network policy
  command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
